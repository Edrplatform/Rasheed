# استكمال وثائق EDR Agent

## المحتوى المفقود الذي يجب إضافته

### 1. استكمال مثال DNS (EventId = 22)

```json
{
  "@timestamp": "2025-01-15T14:07:55.000Z",
  "event.code": 22,
  "event.category": "network",
  "event.action": "dns_query",
  "host.name": "DESKTOP-USER",
  "process.executable": "C:\\Windows\\System32\\svchost.exe",
  "process.pid": 8888,
  "user.domain": "DOMAIN",
  "user.name": "SYSTEM",
  "dns.question.name": "example.com",
  "dns.answers": "93.184.216.34",
  "url.domain": "example.com",
  "dns.response_code": "SUCCESS"
}
```

**شرح التحويل:**
- تعيين الفئة إلى "network" والإجراء إلى "dns_query"
- نقل اسم الاستعلام إلى dns.question.name
- نقل نتائج الاستعلام إلى dns.answers
- نسخ اسم النطاق إلى url.domain لتسهيل البحث
- نقل حالة الاستعلام إلى dns.response_code

---

## الأقسام الإضافية المطلوبة

### كيفية التشغيل والاستخدام

#### متطلبات النظام

- **نظام التشغيل**: Windows 10/11 أو Windows Server 2016+
- **.NET Runtime**: .NET 8.0 أو أحدث
- **Sysmon**: يجب تثبيت وتكوين Sysmon على النظام
- **الصلاحيات**: صلاحيات المسؤول لقراءة سجلات الأحداث

#### أوضاع التشغيل

يدعم EDR Agent ثلاثة أوضاع تشغيل:

**1. وضع التطبيع فقط (normalize) - الوضع الافتراضي**
```bash
EDR_agent.exe
# أو
EDR_agent.exe --normalize
```
يقرأ من ملف `events.jsonl` ويحوله إلى تنسيق ECS.

**2. وضع الجمع فقط (collect)**
```bash
EDR_agent.exe --collect
```
يجمع الأحداث من Windows Event Log ويحفظها في ملف خام.

**3. وضع متكامل (both)**
```bash
EDR_agent.exe --both
```
يجمع الأحداث ويطبعها ويحولها في نفس الوقت.

#### ملف التكوين

يمكن تخصيص سلوك النظام عبر ملف `agent_config.json` في المسار:
```
%APPDATA%\EDRAgent\agent_config.json
```

مثال على ملف التكوين:
```json
{
  "BatchSize": 50,
  "FlushIntervalMs": 2000,
  "ChannelCapacity": 1000,
  "WorkerCount": 2,
  "RawFilePath": "",
  "NormalizedFilePath": ""
}
```

**معاملات التكوين:**
- `BatchSize`: عدد الأحداث قبل الكتابة (افتراضي: 50)
- `FlushIntervalMs`: الفاصل الزمني بالمللي ثانية للكتابة (افتراضي: 2000)
- `ChannelCapacity`: سعة القنوات المحدودة (افتراضي: 1000)
- `WorkerCount`: عدد عمال التطبيع المتزامنين (افتراضي: 2)

---

### استكشاف الأخطاء والحلول

#### المشكلة: "Access Denied" عند قراءة سجلات الأحداث

**الحل**: تشغيل التطبيق بصلاحيات المسؤول:
```bash
Run as Administrator
```

#### المشكلة: لا توجد أحداث يتم جمعها

**الأسباب المحتملة:**
1. Sysmon غير مثبت أو غير قيد التشغيل
2. تصفية الأحداث لا تطابق أي أحداث موجودة
3. سجل Sysmon فارغ

**الحل**:
- تحقق من تثبيت Sysmon: `Get-Service Sysmon64`
- تحقق من وجود أحداث: `Get-WinEvent -LogName "Microsoft-Windows-Sysmon/Operational" -MaxEvents 10`

#### المشكلة: استهلاك عالي للذاكرة

**الحل**: تقليل `ChannelCapacity` و `BatchSize` في ملف التكوين.

#### المشكلة: أخطاء في تحليل XML

**السبب**: أحداث Sysmon بتنسيق غير متوقع

**الحل**: التحقق من إصدار Sysmon وتحديثه إذا لزم الأمر.

---

### الأسئلة الشائعة

**س: هل يمكن تشغيل EDR Agent على Linux؟**
ج: لا، النظام مصمم خصيصاً لـ Windows حيث يعتمد على Windows Event Log و Sysmon.

**س: كيف يمكنني إيقاف التطبيق بشكل آمن؟**
ج: اضغط `Ctrl+C` في وحدة التحكم. سيكمل النظام معالجة الأحداث المعلقة ويغلق بشكل سلس.

**س: هل يمكن تغيير معرفات الأحداث المراقبة؟**
ج: نعم، يمكن تعديل `EVENT_QUERY_FILTER` في `SysmonCollector.cs` وإعادة بناء المشروع.

**س: ما هو الفرق بين الملف الخام والملف الموحد؟**
ج: الملف الخام يحتوي على أحداث Sysmon الأصلية، بينما الملف الموحد يحتوي على الأحداث المحولة إلى تنسيق ECS.

**س: كيف يمكنني زيادة الأداء؟**
ج: زيادة `WorkerCount` و `BatchSize` في ملف التكوين، مع مراقبة استهلاك الموارد.

---

### ملاحظات ختامية

تم إعداد هذه الوثيقة لتوفير فهم شامل لنظام EDR Agent، بما في ذلك بنيته المعمارية، ومكوناته التفصيلية، وآليات عمله، وأمثلة عملية. النظام مصمم ليكون قابلاً للتوسع والتكوين، مما يتيح التكيف مع متطلبات البيئات المؤسسية المختلفة.

للحصول على أحدث التحديثات والمساهمة في المشروع، يرجى الرجوع إلى مستودع الكود المصدري.

</div>
